# -*- coding: utf-8 -*-
"""
Created on Tue Apr 16 15:08:55 2019

@author: Piyush
"""

from ember.features import PEFeatureExtractor
import numpy as np
from keras.models import load_model
import os
import time

model = load_model("relu_dropout.h5")
print ("Model Loaded")
extractor = PEFeatureExtractor()

path = "/data/malware_test/malicious"

file_list = []
y_predict = []

print ("Getting file listing....")
for root, dirs, files in os.walk(path):
    for fname in files:
        current_file = "{}{}{}".format(os.path.abspath(root), os.path.sep, fname)
        file_list.append(current_file)

print ("Starting analysis...")
start = time.time()      

for file in file_list:        
    data = open(file,"rb").read()
    features = np.array(extractor.feature_vector(data), dtype=np.float32).reshape(1,-1)
    y_predict.append(model.predict(features))
    
time_taken = time.time() - start

print ("Execution Time: {}".format(time_taken))
    
y_predict = np.array(y_predict).flatten()

correct = 0
wrong = 0
for y in y_predict:
    if y > 0.5:
        correct = correct + 1
    else:
        wrong = wrong + 1
        
print ("Predicted Correctly: {}".format(correct))
print ("Predicted Incorrectly: {}".format(wrong))
